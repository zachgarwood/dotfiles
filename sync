#!/bin/bash

DIR="$( cd "$( dirname "$0" )" && pwd )"
ORIGINALS=$DIR/originals
DOTFILES=$DIR/.[!.]*

git --work-tree=$DIR --git-dir=$DIR/.git pull

for FILE in $DOTFILES
do
    if [ ! -d $FILE ] && [ ! -h ~/.${FILE##*.} ]
    then
        if [ ! -d $ORIGINALS ]
        then
            mkdir $ORIGINALS
            touch $ORIGINALS/.gitignore
            echo "# This file was generated by $DIR/sync" >> $ORIGINALS/.gitignore
            echo "*" >> $ORIGINALS/.gitignore
        fi
        mv --verbose ~/.${FILE##*.} $ORIGINALS
    fi

    if [ ! -d $FILE ]
    then
        ln --symbolic --verbose $FILE ~/
    fi
done

git --work-tree=$DIR --git-dir=$DIR/.git commit --all
git --work-tree=$DIR --git-dir=$DIR/.git push
